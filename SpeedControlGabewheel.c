#pragma config(UserModel, "C:/Users/rstudent/code/robot-configs/Gabewheel.c")
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

// Always open the debug stream window when the program starts
#pragma DebuggerWindows("debugStream")


#include <CKGeneral.h>
#include <CKVexMotors.h>
#include <CKMovingAverage.h>


MovingAverage maBattery;



float powerForSpeed( float speed ){
	if( speed < 1 ) return 0;
	float p = 0.8856 * exp( 0.0829 * speed );
	return p / getAverage( maBattery );
}


float speedDialValue(){
	return 25*potentiometer(speedDial); //rad/sec of motor output shaft
}


task main(){

	//tMotor motorPorts[] = { mFlyLT, mFlyLB, mFlyRT, mFlyRB };//32
	//tMotor motorPorts[] = { mFlyR, mFlyL };//32A
	//tMotor motorPorts[] = { mFlyT, mFlyB };//35A
	tMotor motorPorts[] = { mFlyB, mFlyM, mFlyT };//Gabewheel


	IMEMotorSet imems;
	IMEMotorSetInit( imems, motorPorts, 3, M393Turbo );

	MovingAverageInit( maBattery, 10 );

	MovingAverage maVelocity;
	MovingAverageInit( maVelocity, 6 );

	MovingAverage maError;
	MovingAverageInit( maError, 4 );

	float targetV, measV, vError = 0, cruisePower, power, e0;
	const float Kq = 0.04, Kd = 0, Ki = 0.02;

	while(true){
		clearTimer(T1);

		nextSample( maBattery, MainBatteryVoltage() );
		targetV = speedDialValue();
		measure( imems );
		nextSample( maVelocity, imems.ime.velocity );
		measV = getAverage(maVelocity);

		e0 = vError;
		vError = measV - targetV;
		float dEdT = (vError - e0) / imems.ime.dt;
		cruisePower = powerForSpeed(targetV);
		float eSquared = vError*vError;
		float qTerm = sgn(vError)*eSquared;
		float iTerm = maError.sum;

		power = cruisePower - (Kq*qTerm + Kd*dEdT + Ki*iTerm);

		setPower( imems, bound(power, 0, 1) );

		writeDebugStreamLine( "%.2f\t%.2f\t%.2f", getAverage(maBattery), targetV, measV );
		delay( 100 - time1[T1] );
	}
}
