#pragma config(UserModel, "C:/Users/rstudent/code/robot-configs/32B.c")
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

// Always open the debug stream window when the program starts
#pragma DebuggerWindows("debugStream")

#include <CKFlywheelSpeedController.h>






task main(){

	FlywheelSpeedController dummyCtlr;
	setFlywheelBatteryConfig( dummyCtlr, NoPort, 1 );

	// 32B
	tMotor motorPortsL[] = { mFlyLF, mFlyLB };
	tMotor motorPortsR[] = { mFlyRF, mFlyRB };

	IMEMotorSet imemsL, imemsR;
	IMEMotorSetInit( imemsL, motorPortsL, 2, M393Turbo );
	IMEMotorSetInit( imemsR, motorPortsR, 2, M393Turbo );

	MovingAverage maAccelerationL, maAccelerationR;
	MovingAverageInit( maAccelerationL, 8 );
	MovingAverageInit( maAccelerationR, 8 );

	MovingAverage maVelocityL, maVelocityR;
	MovingAverageInit( maVelocityL, 8 );
	MovingAverageInit( maVelocityR, 8 );

	const long MinRunTime = 2000;

	for( int rep = 0; rep < 1; ++rep ){
		for( float po = 0.3; po <= 1.001; po += 0.1 ){
			setPower( imemsL, po );
			setPower( imemsR, po );

			long startTime = nPgmTime;
			float avgAccel = 0;
			float vSum = 0;
			int vCount = 0;
			int cruising = 0;

			while( true ){
				long iTime = nPgmTime;
				vSum += flywheelBatteryVoltage(dummyCtlr);
				++vCount;
				measure(imemsL);
				measure(imemsR);
				nextSample( maVelocityL, (imemsL.ime.velocity) );
				nextSample( maVelocityR, (imemsR.ime.velocity) );
				nextSample( maAccelerationL, (imemsL.ime.acceleration) );
				nextSample( maAccelerationR, (imemsR.ime.acceleration) );
				avgAccel = ( getAverage(maAccelerationL) + getAverage(maAccelerationR) ) / 2.0;

				if( nPgmTime - startTime > MinRunTime ){
					if( !cruising ){
						if( avgAccel < 0 ){
							cruising = 1;
						}
					} else if( ++cruising > 30 ){
						break; // cruise for 3 seconds after reaching 0ish acceleration.
					}
				}

				long iterationDuration = nPgmTime - iTime;
				delay( 100 - iterationDuration );
			}

			float voltAvg = vSum / vCount;
			writeDebugStreamLine("%.2f\t%.2f\t%.2f\t%.2f", voltAvg, po, getAverage( maVelocityL ), getAverage( maVelocityR ));

			setPower( imemsL, 0 );
			setPower( imemsR, 0 );
			waitUntilRest( imemsL );
			waitUntilRest( imemsR );
		}
	}
}
