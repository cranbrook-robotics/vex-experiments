#pragma config(UserModel, "C:/Users/rstudent/code/robot-configs/35B.c")
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

// Always open the debug stream window when the program starts
#pragma DebuggerWindows("debugStream")


#include <CKGeneral.h>
#include <CKVexMotors.h>
#include <CKMovingAverage.h>



float powerForSpeed( float speed ){
	return 0.1026 * exp( 0.1888 * speed );
}


float speedDialValue(){
	return 10*potentiometer(pot); //rad/sec of motor output shaft
}


task main(){

	//tMotor motorPorts[] = { mFlyLT, mFlyLB, mFlyRT, mFlyRB };//32
	//tMotor motorPorts[] = { mFlyR, mFlyL };//32A
	//tMotor motorPorts[] = { mFlyT, mFlyB };//35A
	tMotor motorPorts[] = { mFlyRT, mFlyLT, mFlyLB, mFlyRB };//35B

	IMEMotorSet imems;
	IMEMotorSetInit( imems, motorPorts, 4 );

	//MovingAverage maAcceleration;
	//MovingAverageInit( maAcceleration, 5 );

	MovingAverage maVelocity;
	MovingAverageInit( maVelocity, 6 );

	float targetV, measV, vError, cruisePower, power;
	while(true){
		targetV = speedDialValue();
		measure( imems );
		nextSample( maVelocity, imems.ime.velocity );
		measV = getAverage(maVelocity);
		vError = measV - targetV;
		cruisePower = powerForSpeed(targetV);
		power = cruisePower + -0.03*sgn(vError)*vError*vError;
		setPower( imems, bound(power, 0, 1) );
		writeDebugStreamLine( "%.2f\t%.2f\t%.2f", MainBatteryVoltage(), targetV, measV );
		delay( 50 );
	}
}
