#pragma config(UART_Usage, UART2, uartNotUsed, baudRate4800, IOPins, None, None)
#pragma config(I2C_Usage, I2C1, i2cSensors)
#pragma config(Sensor, in1,    pSpeedPot,      sensorPotentiometer)
#pragma config(Sensor, dgtl12, pActivator,     sensorDigitalIn)
#pragma config(Sensor, I2C_1,  ,               sensorQuadEncoderOnI2CPort,    , AutoAssign )
#pragma config(Motor,  port1,           mpTest,        tmotorVex393_HBridge, openLoop, encoderPort, I2C_1)
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

// Always open the debug stream window when the program starts
#pragma DebuggerWindows("debugStream")


#include <CKGeneral.h>
#include <CKVex.h>
#include <CKVexMotors.h>

#define CKMovingAverageSampleSize 8
#include <CKMovingAverage.h>






task main(){

	tMotor motorPorts[] = { mpTest };

	IMEMotorSet imems;
	IMEMotorSetInit( imems, motorPorts );

	MovingAverage maAcceleration;
	MovingAverageInit( maAcceleration );

	MovingAverage maVelocity;
	MovingAverageInit( maVelocity );

	float v = MainBatteryVoltage();

	while( !isPressed(pActivator) )  delay(10);
	while(  isPressed(pActivator) )  delay(10);

	const long MinRunTime = 2000;

	//float po = potentiometer(pSpeedPot);

	for( int rep = 0; rep < 20; ++rep ){
		for( float po = 0.1; po <= 1.001; po += 0.1 ){
			setPower( imems, po );

			long startTime = nPgmTime;
			float avgAccel = 0;
			float vSum = 0;
			int count = 0;
			while( !isPressed(pActivator) ){
				long iTime = nPgmTime;
				v = MainBatteryVoltage();
				vSum += v;
				measure(imems);
				nextSample( maVelocity, imems.ime.velocity );
				nextSample( maAcceleration, imems.ime.acceleration );
				avgAccel = getAverage( maAcceleration );
				//writeDebugStreamLine("%.2f\t%.3f\t%.3f\t%.3f", v, testMotor.power, testMotor.position, testMotor.velocity, avgAccel);
				if( nPgmTime - startTime > MinRunTime && avgAccel < 0 ){
					break;
				}
				long iterationDuration = nPgmTime - iTime;
				delay( 100 - iterationDuration );
				++count;
			}

			float voltAvg = vSum / count;
			float vel = getAverage( maVelocity );
			writeDebugStreamLine("%.2f\t%.1f\t%.3f", voltAvg, po, vel);

			//gradualStop( testMotor );
			setPower( imems, 0 );
			waitUntilRest( imems );
			//writeDebugStreamLine("");
		}
	}
}
