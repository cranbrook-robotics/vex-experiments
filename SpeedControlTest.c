#pragma config(UserModel, "C:/Users/rstudent/code/robot-configs/Gabewheel.c")
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

// Always open the debug stream window when the program starts
#pragma DebuggerWindows("debugStream")


#include <CKGeneral.h>
#include <CKFlywheelSpeedController.h>


/*_________________________________________________________
 *
 * Robot-specific parameters
 */

const int NFlywheels = 1;
const Motor393GearBox FlywheelGearbox = M393Turbo;
const int MotorsPerFlywheel = 3;

const tMotor motorPorts [NFlywheels] [MotorsPerFlywheel] = {
	//{ mFlyLT, mFlyLB, mFlyRT, mFlyRB }//32
	//{ mFlyR, mFlyL }//32A
	//{ mFlyT, mFlyB }//35A
	//{ mFlyLF, mFlyLB }, { mFlyRF, mFlyRB }//35
	{ mFlyB, mFlyM, mFlyT }//Gabewheel
};

// power = A e^( B speed )
const float A = 0.8856;
const float B = 0.0829;

// Controller coefficients
const float Kq = 0.04, Kd = 0, Ki = 0.02;

//_________________________________________________________






float speedDialValue(){
	return 25*potentiometer(speedDial); //rad/sec of motor output shaft
}


task main(){
	FlywheelSpeedController ctlrs[NFlywheels];
	for( int f = 0; f < NFlywheels; ++f ){
		FlywheelSpeedControllerInit( ctlrs[f], Kq, Ki, Kd, A, B, motorPorts, MotorsPerFlywheel, FlywheelGearbox );
	}

	//MovingAverageInit( maBattery, 10 );


	while(true){
		clearTimer(T1);

		for(int f = 0; f < NFlywheels; ++f) {
			setTargetSpeed( ctlrs[f], speedDialValue() );
			update( ctlrs[f] );
		}

		writeDebugStream( "%.2f", MainBatteryVoltage() );
		for(int f = 0; f < NFlywheels; ++f) {
			FlywheelSpeedController& c = ctlrs[f];
			writeDebugStream( "  |  %.2f \t %.2f \t %.2f", c.targetSpeed, getAverage( c.maFlywheelSpeed ), c.controlPower );
		}
		writeDebugStreamLine("");

		delay( 100 - time1[T1] );
	}
}
