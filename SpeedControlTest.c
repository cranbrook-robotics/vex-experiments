#pragma config(UserModel, "C:/Users/rstudent/code/robot-configs/35B.c")
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

// Always open the debug stream window when the program starts
#pragma DebuggerWindows("debugStream")

#define POWER_EXPANDER_A1
#include <CKFlywheelSpeedController.h>


/*_________________________________________________________
 *
 * Robot-specific parameters
 */

const Motor393GearBox FlywheelGearbox = M393HighSpeed;
const int MotorsPerFlywheel = 3;

const tMotor motorPorts[] =
	//{ mFlyR, mFlyL }//32A
	//{ mFly1, mFly2, mFly3, mFly4 }//35A
	{ flyFour, flyOneYThree, flyTwo }//35B
	//{ mFlyB, mFlyM, mFlyT }//Gabewheel
;

// power = A e^( B speed )
// 1.2889e0.0925x
const float A = 1.2889;
const float B = 0.0925;

// Controller coefficients
const float Kq = 0.1, Kd = 0, Ki = 0.03;

//_________________________________________________________



FlywheelSpeedController ctlr;



float speedDialValue(){
	return 16*potentiometer(speedDial); //rad/sec of motor output shaft
}

task control(){
	while(true){
		setTargetSpeed( ctlr, speedDialValue() );
		update( ctlr );
		delay(50);
	}
}

task main(){
	FlywheelSpeedControllerInit( ctlr, Kq, Ki, Kd, A, B, motorPorts, MotorsPerFlywheel, FlywheelGearbox );
	setFlywheelBatteryConfig( ctlr, pPowerExp, 0.5 );

	//MovingAverageInit( maBattery, 10 );

	startTask(control);

	while(true){
		writeDebugStream( "%.2f", flywheelBatteryVoltage(ctlr) );
		FlywheelSpeedController& c = ctlr;
		writeDebugStreamLine( "  |  %.2f \t %.2f \t %.2f", c.targetSpeed, getAverage( c.maFlywheelSpeed ), c.controlPower );

		delay( 200 );
	}
}
