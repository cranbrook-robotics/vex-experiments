#pragma config(UserModel, "C:/Users/rstudent/code/robot-configs/35A-in-and-out.c")
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

// Always open the debug stream window when the program starts
#pragma DebuggerWindows("debugStream")

#define POWER_EXPANDER_A1
#include <CKFlywheelSpeedController.h>


/*_________________________________________________________
 *
 * Robot-specific parameters
 */

const Motor393GearBox FlywheelGearbox = M393HighSpeed;
const int MotorsPerFlywheel = 4;

const tMotor motorPorts[] =
	//{ mFlyR, mFlyL }//32A
	{ mFly1, mFly2, mFly3, mFly4 }//35A
	//{ flyFour, flyOneYThree, flyTwo }//35B
	//{ mFlyB, mFlyM, mFlyT }//Gabewheel
;

// power = A e^( B speed )
// 1.2235e0.1072x
const float A = 1.2235, B = 0.1072;

// Controller coefficients
const float Kq = 0.2, Kd = 0, Ki = 0.05;

//_________________________________________________________



FlywheelSpeedController ctlr;



float speedDialValue(){
	return 16*potentiometer(speedDial); //rad/sec of motor output shaft
}

task control(){
	while(true){
		setTargetSpeed( ctlr, speedDialValue() );
		update( ctlr );
		delay(30);
	}
}

task main(){
	FlywheelSpeedControllerInit( ctlr, Kq, Ki, Kd, A, B, motorPorts, MotorsPerFlywheel, FlywheelGearbox );
	setFlywheelBatteryConfig( ctlr, powerExpVoltage, 0.5 );

	//MovingAverageInit( maBattery, 10 );

	startTask(control);

	while(true){
		writeDebugStream( "%.2f", flywheelBatteryVoltage(ctlr) );
		FlywheelSpeedController& c = ctlr;
		writeDebugStreamLine( "  |  %.2f \t %.2f \t %.2f", c.targetSpeed, getAverage( c.maFlywheelSpeed ), c.controlPower );

		delay( 100 );
	}
}
