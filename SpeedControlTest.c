#pragma config(UserModel, "C:/Users/rstudent/code/robot-configs/35A-in-and-out.c")
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

// Always open the debug stream window when the program starts
#pragma DebuggerWindows("debugStream")


#include <CKFlywheelSpeedController.h>


/*_________________________________________________________
 *
 * Robot-specific parameters
 */

const Motor393GearBox FlywheelGearbox = M393Standard;
const int MotorsPerFlywheel = 4;

const tMotor motorPorts[] =
	//{ mFlyR, mFlyL }//32A
	{ mFly1, mFly2, mFly3, mFly4 }//35A
	//{ mFlyB, mFlyM, mFlyT }//Gabewheel
;

// power = A e^( B speed )
// 0.8869e0.1757x
const float A = 0.8869;
const float B = 0.1757;

// Controller coefficients
const float Kq = 0.2, Kd = 0, Ki = 0.03;

//_________________________________________________________






float speedDialValue(){
	return 11*potentiometer(speedDial); //rad/sec of motor output shaft
}


task main(){
	FlywheelSpeedController ctlr;
	FlywheelSpeedControllerInit( ctlr, Kq, Ki, Kd, A, B, motorPorts, MotorsPerFlywheel, FlywheelGearbox );
	setFlywheelBatteryConfig( ctlr, in1 /*pPowerExpander*/, 0.5 );

	//MovingAverageInit( maBattery, 10 );


	while(true){
		clearTimer(T1);

		setTargetSpeed( ctlr, speedDialValue() );
		update( ctlr );

		writeDebugStream( "%.2f", flywheelBatteryVoltage(ctlr) );
		FlywheelSpeedController& c = ctlr;
		writeDebugStreamLine( "  |  %.2f \t %.2f \t %.2f", c.targetSpeed, getAverage( c.maFlywheelSpeed ), c.controlPower );

		delay( 100 - time1[T1] );
	}
}
