#pragma config(UserModel, "C:/Users/rstudent/code/robot-configs/39.c")
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

// Always open the debug stream window when the program starts
#pragma DebuggerWindows("debugStream")

//#define POWER_EXPANDER_A1
#include <CKFlywheelSpeedController.h>


/*_________________________________________________________
 *
 * Robot-specific parameters
 */

const Motor393GearBox FlywheelGearbox = M393HighSpeed;
const int MotorsPerFlywheel = 4;

const tMotor motorPorts[] =
	//{ mFlyR, mFlyL }//32A
	//{ mFly1, mFly2, mFly3, mFly4 }//35A
	//{ flyFour, flyOneYThree, flyTwo }//35B
	//{ mFlyB, mFlyM, mFlyT }//Gabewheel
		{ WheelTwoAndFour, WheelOneAndThree}
;

// power = A e^( B speed )
// 0.7555e0.1314x
//0.9397e0.2149x
const float A = 0.9397, B = 0.2149;

// Controller coefficients
const float Kq = 0.15, Kd = 0.0, Ki = 0.03;

//_________________________________________________________



FlywheelSpeedController ctlr;



float speedDialValue(){
	return 10*potentiometer(speedDial); //rad/sec of motor output shaft
}

task control(){
	while(true){
		setTargetSpeed( ctlr, speedDialValue() );
		update( ctlr );
		delay(50);
	}
}

task main(){
	FlywheelSpeedControllerInit( ctlr, Kq, Ki, Kd, A, B, motorPorts, MotorsPerFlywheel, FlywheelGearbox );
	setFlywheelBatteryConfig( ctlr, vPowerExpander, 1.0);

	startTask(control, kHighPriority);

	while(true){
		writeDebugStream( "%.2f", flywheelBatteryVoltage(ctlr) );
		FlywheelSpeedController& c = ctlr;
		writeDebugStreamLine( "\t | \t %.2f \t %.2f \t %.2f", c.targetSpeed, getAverage( c.maFlywheelSpeed ), c.controlPower );

		delay( 100 );
	}
}
