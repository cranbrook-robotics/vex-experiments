#pragma config(UserModel, "C:/Users/rstudent/code/robot-configs/32B.c")
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

// Always open the debug stream window when the program starts
#pragma DebuggerWindows("debugStream")

#include <CKFlywheelSpeedController.h>


FlywheelSpeedController ctlrL, ctlrR;



float speedDialValue(){
	return 24*potentiometer(speedDial); //rad/sec of motor output shaft
}



void init(){
	const Motor393GearBox Gearbox = M393Turbo;
	const tMotor motorPortsL[] = {mFlyLF, mFlyLB};
	const tMotor motorPortsR[] = {mFlyRF, mFlyRB};
	const float Kq = 0.05, Ki = 0.03, Kd = 0;

	// 1.2908e0.0602x
	FlywheelSpeedControllerInit( ctlrL, Kq, Ki, Kd, 1.2908, 0.0602, motorPortsL, 2, Gearbox );
	// 1.4517e0.056x
	FlywheelSpeedControllerInit( ctlrR, Kq, Ki, Kd, 1.4517, 0.0560, motorPortsR, 2, Gearbox );
}



float speed = 0;



task ControlLoop() {
	while(true){

		setTargetSpeed( ctlrL, speed );
		setTargetSpeed( ctlrR, speed );
		update( ctlrL );
		update( ctlrR );

		delay(30);
	}
}



task main(){
	init();
	startTask(ControlLoop, kHighPriority);

	while(true){
		speed = speedDialValue();

		writeDebugStream( "%.2f", MainBatteryVoltage() );
		writeDebugStream( "  |  %.2f \t %.2f \t %.2f", ctlrL.targetSpeed, getAverage( ctlrL.maFlywheelSpeed ), ctlrL.controlPower );
		writeDebugStream( "  |  %.2f \t %.2f \t %.2f", ctlrR.targetSpeed, getAverage( ctlrR.maFlywheelSpeed ), ctlrR.controlPower );
		writeDebugStreamLine("");

		delay( 200 );
	}
}
