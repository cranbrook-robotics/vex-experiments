#pragma config(UserModel, "C:/Users/rstudent/code/robot-configs/32B.c")
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

// Always open the debug stream window when the program starts
#pragma DebuggerWindows("debugStream")


#include <CKGeneral.h>
#include <CKFlywheelSpeedController.h>


/*_________________________________________________________
 *
 * Robot-specific parameters
 */

//const int NFlywheels = 2;
const Motor393GearBox FlywheelGearbox = M393Standard;
const int MotorsPerFlywheel = 2;

//left  1.2762e0.138x
//right
// Controller coefficients
const float Kq = 0.04, Kd = 0, Ki = 0.02;

//_________________________________________________________






float speedDialValue(){
	return 11*potentiometer(speedDial); //rad/sec of motor output shaft
}


task main(){
	FlywheelSpeedController ctlrL, ctlrR;

	const tMotor motorPortsL[] = {mFlyLF, mFlyLB};
	const tMotor motorPortsR[] = {mFlyRF, mFlyRB};

	//1.2762e0.138x
	FlywheelSpeedControllerInit( ctlrL, Kq, Ki, Kd, 1.2762, 0.138, motorPortsL, MotorsPerFlywheel, FlywheelGearbox );
	//1.2721e0.1416x
	FlywheelSpeedControllerInit( ctlrR, Kq, Ki, Kd, 1.2721, 0.1416, motorPortsR, MotorsPerFlywheel, FlywheelGearbox );


	//MovingAverageInit( maBattery, 10 );


	while(true){
		clearTimer(T1);

		float speed = speedDialValue();
		setTargetSpeed( ctlrL, speed );
		setTargetSpeed( ctlrR, speed );
		update( ctlrL );
		update( ctlrR );

		writeDebugStream( "%.2f", MainBatteryVoltage() );
		writeDebugStream( "  |  %.2f \t %.2f \t %.2f", ctlrL.targetSpeed, getAverage( ctlrL.maFlywheelSpeed ), ctlrL.controlPower );
		writeDebugStream( "  |  %.2f \t %.2f \t %.2f", ctlrR.targetSpeed, getAverage( ctlrR.maFlywheelSpeed ), ctlrR.controlPower );
		writeDebugStreamLine("");

		delay( 100 - time1[T1] );
	}
}
